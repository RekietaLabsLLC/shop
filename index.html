<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RekietaLabs Market</title>
  <link rel="icon" href="IMG_0926.jpeg" type="image/jpeg"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: black;
      color: white;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #111;
      padding: 10px;
      text-align: center;
      font-size: 24px;
      color: #1753aa;
      font-weight: bold;
    }

    #searchBar {
      margin: 10px auto;
      display: flex;
      justify-content: center;
    }

    #searchInput {
      padding: 8px;
      width: 80%;
      max-width: 500px;
      background-color: #222;
      color: white;
      border: 2px solid #1753aa;
      border-radius: 4px;
    }

    #products {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
    }

    .product {
      background-color: #222;
      border-radius: 8px;
      padding: 15px;
      width: 250px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: background-color 0.3s;
    }

    .product:hover {
      background-color: #1e2d45;
    }

    .product img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }

    .product-title {
      font-size: 18px;
      margin: 10px 0;
    }

    .product-price {
      color: #ccc;
      margin-bottom: 10px;
    }

    .product button {
      background-color: #1753aa;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 4px;
      cursor: pointer;
    }

    #cartToggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #1753aa;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      z-index: 1000;
    }

    #cartPanel {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: #111;
      border: 1px solid #333;
      border-radius: 8px;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      padding: 15px;
      z-index: 1000;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .cart-item input {
      background-color: #222;
      border: 1px solid #555;
      color: white;
      width: 50px;
      text-align: center;
      border-radius: 4px;
    }

    .cart-item button {
      background-color: #333;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    #checkoutBtn {
      background-color: #1753aa;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 4px;
      margin-top: 10px;
      cursor: pointer;
    }

    #errorMessage {
      color: #ff6961;
      font-size: 14px;
      margin-top: 10px;
      white-space: pre-wrap;
    }

    @media (max-width: 600px) {
      #cartPanel {
        width: 90%;
        right: 5%;
      }

      #searchInput {
        width: 90%;
      }

      .product {
        width: 90%;
      }
    }
  </style>

  <!-- Hotjar Tracking Code for RekietaLabs Market -->
  <script>
      (function(h,o,t,j,a,r){
          h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
          h._hjSettings={hjid:6495276,hjsv:6};
          a=o.getElementsByTagName('head')[0];
          r=o.createElement('script');r.async=1;
          r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
          a.appendChild(r);
      })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>
</head>
<body>

  <header>RekietaLabs Market</header>

  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Search products..." />
  </div>

  <div id="products"></div>

  <button id="cartToggle">ðŸ›’</button>
  <div id="cartPanel">
    <div id="cartItems"></div>
    <button id="checkoutBtn">Checkout</button>
    <div id="errorMessage"></div>
  </div>

  <script>
    const products = [
      {
        id: "wizard-dino",
        name: "Wizard Dino (Customizable)",
        price: 3.00,
        image: "https://market.rekietalabs.com/IMG_0004.jpeg"
      },
      {
        id: "fidget-tree",
        name: "Fidget Tree (Customizable)",
        price: 8.00,
        image: "https://market.rekietalabs.com/IMG_0937.jpeg"
      },
      {
        id: "flower-fidget-a",
        name: "Flower Fidget (GITD)",
        price: 8.00,
        image: "https://market.rekietalabs.com/IMG_0003-2.jpeg"
      },
      {
        id: "flower-fidget-b",
        name: "Flower Fidget (Rainbow)",
        price: 8.00,
        image: "https://market.rekietalabs.com/IMG_1156 2.jpeg"
      },
    ];

    const cart = {};

    const productsContainer = document.getElementById('products');
    const cartPanel = document.getElementById('cartPanel');
    const cartToggle = document.getElementById('cartToggle');
    const cartItems = document.getElementById('cartItems');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const errorMessage = document.getElementById('errorMessage');
    const searchInput = document.getElementById('searchInput');

    function updateCart() {
      cartItems.innerHTML = '';
      for (const [id, qty] of Object.entries(cart)) {
        const product = products.find(p => p.id === id);
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <span>${product.name}</span>
          <input type="number" value="${qty}" min="1" max="30" onchange="cart['${id}'] = parseInt(this.value) || 1">
          <button onclick="delete cart['${id}']; updateCart()">Remove</button>
        `;
        cartItems.appendChild(div);
      }
    }

    function displayError(msg, refId) {
      errorMessage.textContent = `${msg} (Ref ID: ${refId})`;
    }

    cartToggle.onclick = () => {
      cartPanel.style.display = cartPanel.style.display === 'block' ? 'none' : 'block';
      updateCart();
      errorMessage.textContent = '';
    };

    checkoutBtn.onclick = async () => {
      errorMessage.textContent = '';

      const cartArray = Object.entries(cart).map(([id, qty]) => ({ id, qty }));
      if (cartArray.length === 0) {
        return displayError("Your cart is empty.", "3400116");
      }

      try {
        const response = await fetch("https://api.rekietalabs.com/market-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cart: cartArray })
        });

        const data = await response.json();

        if (response.ok && data.url) {
          window.location.href = data.url;
        } else {
          displayError(data.error || "Checkout failed.", data.refId || "3400126");
        }
      } catch (err) {
        displayError("Network error. Please try again later.", "3400136");
      }
    };

    function renderProducts() {
      const query = searchInput.value.toLowerCase();
      productsContainer.innerHTML = '';

      products
        .filter(p => p.name.toLowerCase().includes(query))
        .forEach(product => {
          const div = document.createElement('div');
          div.className = 'product';
          div.innerHTML = `
            <img src="${product.image}" alt="${product.name}" />
            <div class="product-title">${product.name}</div>
            <div class="product-price">$${product.price.toFixed(2)}</div>
            <button onclick="cart['${product.id}'] = (cart['${product.id}'] || 0) + 1; updateCart()">Add to Cart</button>
          `;
          productsContainer.appendChild(div);
        });
    }

    searchInput.addEventListener('input', renderProducts);
    window.addEventListener('load', renderProducts);
  </script>
</body>
</html>
